using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AdventOfCode2023
{
    [DebuggerNonUserCode]
    internal class Day21
    {
        const string TESTMAZESTRING = 
@"...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........";

        const string MAZESTRING =
@"...................................................................................................................................
...............##....#.......#.....#..#...............#....#..........#........#.........#....#.............#.##.#.......#.#.......
..............#..........#....##.#..........#......###.#.##...............#....#....#.#........##.....#..#.##..............#...##..
........##....#..#.......#...#.#.........#.#.......#......#..............#.........#.........#....#.....#..#....##..##......#......
......#..#...#...##.........#....##...#.#......#..........................#.....#...#..............................#..........#....
..#.#..#...............#...........##.....#.#.#.................#...........#.....##.#..#...............#....#.#...#.........#...#.
....##...#.#............#.#.....#..........#.#.#................#................##.#...#.....#........#....#...#......#...#.......
..#.....##.#....#.........#.#..#.............#.##.............#.#.#.................#...................##.........................
.#...#....#..##....#...........#...##..#..#.#.###.##...........#...............#......#...##...#................#...#......#.....#.
.............##....#........#....#...#...........#............#....##...........#.....#......#..#.#.#.###......................##..
.............#...##.................#...#......#...........#....#....................#.#.#....#.....#....#...#.......#.#..#.##...#.
........#.##...#.###........#.##.##..........#.............#...........#.........#......##..#......#.......#.....#......##..#......
.....#.#.#.#..#..........##...........##.........#.......#...#.........#..........#.#.....#.#..#...#...........#.......#......##...
.............#...##.......#.###...##.........................#......#...#............................#....#.#...#..#......#.#.#.##.
....................###...##.............#..#.................#...##....#.#...............#...####...##.......#....##..........#.#.
.#..#..#.##.#..##.....#....####...#..#....#...........#..#...#.............#.........#......#.......#......#.......#...........#...
......#..........#............#.#........#.#...........##..........##.#....#...........#...........#....#.#...#..##................
.......#...#.....#..#.....#...........#....#........#..#.......#.....#.#..#............#..#.#...........#..............#....#......
.......##.#.......#.....#..........##.#..#..........................#...#.#..#................#..#..#...#.........###...#..........
........#............#..#............#.............##....................###......................#.#..#....##.##.......#..#.....#.
.#................#..#................##............#.............#.#.#........#............#.#..#.#.........#....#.#....#.........
..#....#......###........#.......................#...#......#.....#..#..#.....................................#........#......#....
..#.....#...#.........#.#.........#..#.#.......##..#.#...##..##........#..#.......#...............#..........#.....#..........#.#..
....#...#.....................###......................#......#.......#......#.....##.............#....#......##.....#..#.....###..
.#....#....#...##.#....#..#.#.....................#....#..#..#.#..#.......#..##...#.#........#........#..#....#......##..#...#.#...
.............#.#............................#..#....#...#.#..........#......#.....................#.......##.....##................
...................#......#.....#..........#......#.......##.#.........................#...........#....##..........#.#...#........
.......#.#.##........#..........................#...#................#.......#......#.............#................#.#....#......#.
...........###.#...##.#...#......#..........#....#.#........#...........##..........#.#...............###.....#...#...#...#........
.##...#.....#.........#....#......................#.#..........#.......#.....#.#........#..............#.........#..##.##..........
....##.#.............#.....#...........#....#....#.###...#...#..........#................#..................#.#.......#...#....#...
..##...#.....#..........##.#..............#..#..............#.....#.#.......#.#...#....................#..........#.#.......#.##...
.....#...#..................#....................#..#...##...........#...........#.......#.#.................#...#...#.#.....#.....
.........#.....#.#.#.....#.............#...#.......#.#..#...........................#..#.#.#..#.......#.......#......#...#......#..
.#....##.........#...#.............#.##.........#..##......#..............#.........#.....##............#..#.##.#........##........
.#......#.........#..#...#.............#......#....#....#..#...#...#......#.#.....#....#..##................#.#....#..#....##......
..................#.###................#...#..#..##.#.....#....#...##..........#...#.......................##.................#....
......#.........................#...#.##.......#.........#...#....#.#......#.....................#.........##..#.................#.
.......#...........#....................#.#.....##........##..#...###.....#......................#..............#..............#...
......#....#.....#...#...........#..#..##..#.................##.................#.#...............#..........#...#....#.........#..
.#...#........#....#......................#.##......................###..............#.....##...#.................#.#...##.......#.
...................#..........#.............#......#.#.#.......#..#.#........#..##.....#.....#.##..##........................#...#.
.....#...........#.............#.........#..#...#.#..#.....#............##......#......#..........#......................#..#...#..
..#......#....#...........#.......#.......#..#.#.....#...##.......#......#.....#.........#...........##.#.......#........#..##.....
.......#.#...#...........##.....#...#.............#.#......##............#.#........#............##.............................#..
..................................#........##..........#.#.#....#................#.#.##..##.....#.......#................#.......#.
..#..#.....##.#......................#.#.....#.....##..#.......#...#.......#..#.....#...#.......#...#..............##....#.....#...
..........#..#...............#.#...............###.........#.......#.#................................#..................#.#..#....
............#..........#..........#.....#......##...#..............#.#...........#..##....#..........................#....#..#..#..
.....#.....#...........#..#......#..#...........#.#......#.#.........................#...#...#....#.....#.##............##.........
...#....#........................##......#.#........##.........#......#.......##..............#...#..#....#..................#.##..
...#.#...##........#.........##.##.....#........#.#....................#.#...#.......#.....#.................#.#........#..........
...#.#.###...................#...#.#.......#.#.#...#.#.#...#..#.#.....#...#....#..................##.......#...............#.....#.
....###.............#..#.............##..#.........#......#....#.......#.#.......#...#..........#.#................................
.....................#..#........##...#....#..........#........#.......#...##....#..#......#.............#......#............#..#..
..#.............#........#.##..#....#..#........##............#.......#.....#..#...........#..#....##.#.....................#......
..#........................#.......#....#.#.......##.##...........#..........#..#...........#.#.............#.#.....##.............
.#.................#..........#..#........#...........#....##............#.##..##...............................#...#..............
...........#..............#........#..#........#......#.....#.##...#...#....#.......#........#...........#.#.....#....#............
............#..##.#....##..##..#.#....#.#.#......#.#...........#...#....#..........#.........#..#...............................#..
............#.......#.....#.....#................#..#.#...#.................#.........#............#...#..##.#.......#.............
.............#..#........#....#.#...#...#..#..#..........#.#.##.......#......##.#.............##..........##............#..........
........#...#..#.#.#...........#...#....#.....#...........#........#......#..#.#....##............#....##..##...#..................
...........#..........#.#.#...........#.............#...###.................#.#.#.#............#.........#.....#..#..#.............
............#....#.........#..#.....#......#.#...........................#..#.........#...#........#.#..............#.....##.......
.................................................................S.................................................................
...........#........#........#......#..#..##.#.............#...................#...#.#......#.................#.....##.............
........#.........#..##..###..#.................#.###.......#.........#............#.....#..........#.....#..#.....#.#......#......
........#.........#..#...###.....#..........#....#.#.....#......#...#....#.##.#........#..#....#...................................
.............#.#......##......#...#..#.....#.#..#.##.#.#........#..............#...........#.........#.....##...#.#.##.............
..................###..#.........#........##...#..#........#.#.........#........#.........#....#..#.#.........#.....#..............
.#..........#..........#..#...........................##.#.#.#..#....#...#........##.#.............................#..#............
................#......#......#....#..........#.#....#...........................#...#..#......#...#.........#....#....#.........#.
................#...#.#.....#.#.......#...#....#......#.........#....#........#.......#.....................#.#.#.............#..#.
....#........#................#..........###...........#.#.............#............#.............#....#.......#..............#.#..
......#................#..#..#.............##......#.#........#....#....#..#..................#......###....#......#.........#.....
.#...#.........#........................#...#..##.....#.#...............#...............#..#......#.....#..........................
..##...............###...##.......#............#.##..........##.#....#.........#.#.#....##...#..#.............#.................#..
.#...............#.....#...#.......#.............#..#......#....#...#......#......##......#.......#..##...#.#..#..............#....
.......................#....#.......##...#.#.......#..#.....#...............##...#..#......#.#..#....#...#...................#.....
..##..#..#.......................#..#.#.##.........#...##.....#.....#.....#...###....###........#.#..#.........#..........#........
.......#....................#.........#..#.#....#...#..#...............#.........##...................###.#.............#...#...#..
.....................#...###..#.............#........#.#......#....#.#...##..#...........................#..#...........#..#.......
..##.......#..........#..........#...............#...##......#........................................#.............#.#......##....
.#...........#.........##..#.......#..........................#.....##..#.............#....#....#.#.#.#.....................#####..
............##............#......#......#......##.....#.##.....##..............#..#....#....###.###..#...#........#..........#...#.
...#.#.........#.#.......#..###.##.#............#............................#...................###................#..#....#......
..###..........................#.#...........#..#..#.......##............#....#.....#..##...........###.........##..##.......#..#..
..#.....#........................#.#.................#####...#..#.....#.....#........#.#.......................#.....#.......#.##..
...#................#.............#..#.........#........##............#........#.......#...##.#......#...................#......#..
.......#.#.....#..............#.....#....#.#.....##..#..#....####.#.....#..#...#...#....#.#..#...##....................##....###...
.............#....#......................#...##..#......#..#.........##....#.......#...##....................#.#..#.#..............
..#....#..##........#............##...#....#...........................................#....#....#...........#..............#......
....#.....#.......#...............................#.........#.........##...........#.#.....#..#...#............#....#..........###.
......#...........#..............##.#..#.............................#.#.#........#..#.....#....#.........................#......#.
.....#...#...#..#.........#..........#....#..#...#.......##.#.#...##...#...#.#....#.....#...................#.........#.........#..
........##..#.....#...##...........##.#.#.#......#....#.#......#.....#...............#.......##.............#................#.#...
.#......#.......#.......#......................#..#...#...#.........##......#......#.......#...........#....#..#............#....#.
...#.....#..#.#........#....##.......#...#..#..#..##.#............#............#...#...............................#.......###..#..
..#.#......#.....##.#.#.......#.............#....#.#........#.....#...........#....###...........................##................
...#.......#.....#.....................#....##....#..#..#....##.............#......#.#....#...........................##..#.##.....
...###..#.............#...#.#..............##......#.....#...#.......##.#...#............#..........#...#.....#.......#........#.#.
.#........#...........#..#................#...#...#.......#..........#..#......#..#..#.....................#...#......#.........#..
........#....#.......#.........#.............#.....#...........#...#..#.#.####......#............#....#.......#.....#..............
......#.###.#........#.........#...#.......#..#.....#.......#............#..#.....#.#...............................#..#.#...###...
......#............#....#......#.#..........#....#.............................#...##..............#...##.#...#...#................
..##........#...#...............#..............#...#.#.#....#.....#.##..#........#...#...................#.........#.##.........#..
.##........#......................#............###............#...........#.......#.........#.....#......#...#.........#......#..#.
...#.#.....##...#...............###.............##....#..#.#..#....................#.......#...#............##..#............#.....
..............#....#.....#.#..#.......................................##.#.....#...............#.........#....#.....#.#..#.#...#...
...#.#........##.......#...##..#..##....#.............#.....#.....#..#..........#..........#........##...............#....#.....#..
...#.........#..#..................#.#................#.........#....#...#..........................#....##.......#...#...#........
.....#..#.##.........###...#.#........#......................#.#........#.#....#.......#...........#....#...#......#.#..##...##..#.
...#.............................#.....#....#.......##.#...............#.#............#.............#..#...........#......#........
.#.........##.#.#..#.........##.#.....#..#.................................#............##.#..............#........#...#...#..#.##.
...#.##....#....##.#....#.#.#....#.....#......#...................#..###....................##...#..##..#...#...#.......##...#.....
..#..#..#...#.#...........................................#..#..#..#.#.#................#........#.#.#.....#..#......#.......#.#.#.
..........#.........#..#.#.........#...........#..................#...#..##.......#........#...........#..................#....#...
..#..#..........#....#.....##.###...##.......##............##...#....................#............###......#.......#.............#.
..........#...#...............#.......#.#......#...........#..#...................#.....##.##..#.#..................##.....#...#...
..........#..#...........#..#.#.....#..#..##..#............#........................#......#.......#...#..#...........#..#...#...#.
....##...............#........##.........#.#.....#.#........#..#.................#..#....#.#...#.#..........................#......
.#......##........#.............#........#...##..#..................#.............#....#.....#.............#...#............#......
...........#......#.#.........#.#...#..#............#...............#.........#...#..#..............#......##..#......#.#...#......
.....#...........#.........#....#.###.............##.#.......................#.....#.....#.......##.........###....................
......#.#.#......#.#..#..#..##..#..##...#....................................#.....##.#.#..#..#.......#.#.#.###........#....####.#.
..........##......#.........##.#.#...........###.............................#.........#....#..#.....#........##...........#..##...
.......#...##.............#..#.....#..#..#..#.........#...................#...........#..#...............#..##.#................##.
.#..............#...#..........#...#.###.....#...#.....#..........................#..##...##..##....#....#......#.#..##...#....#.#.
...........##....#......#...........#..#......#..........#....................#.#....#.#.......#..#.#.#.........#..................
...................................................................................................................................";

        static List<(int, int)> DIRECTIONS = new List<(int, int)>() { ( 0, 1 ), ( 0, -1 ), ( 1, 0 ), ( -1, 0 ) };
        const int STEPS = 480;

        public static void Run()
        {
            var ls = MAZESTRING.Split("\r\n", StringSplitOptions.RemoveEmptyEntries);
            var maze = new char[ls[0].Length, ls.Count()];
            var pointsExploredAtStep = new List<long>();

            var pointsExplored = new HashSet<(int, int)>();
            var pointsToExplore = new List<(int, int)>();

            for (var x = 0; x < ls[0].Length; x++)
            {
                for (var y = 0; y < ls.Count(); y++)
                {
                    maze[x, y] = ls[y][x];

                    if (ls[y][x] == 'S') { 
                        pointsToExplore.Add((x, y));
                        maze[x, y] = '.';
                        //pointsExplored.Add((x, y)); 
                    }
                }
            }

            for (var i = 0; i < STEPS; i++)
            {
                var newPointsToExplore = new List<(int, int)>();
                pointsExplored = new HashSet<(int, int)>();
                foreach (var pte in pointsToExplore)
                {
                    foreach (var dir in DIRECTIONS) {
                        var newPoint = (pte.Item1 + dir.Item1, pte.Item2 + dir.Item2);

                        // Part B: do some mod
                        var infiniteX = newPoint.Item1 % ls[0].Length;
                        var infiniteY = newPoint.Item2 % ls.Count();
                        if (infiniteX < 0) infiniteX = ls[0].Length + infiniteX;
                        if (infiniteY < 0) infiniteY = ls.Count() + infiniteY;
                        if (!pointsExplored.Contains(newPoint)
                            && maze[infiniteX, infiniteY] == '.')
                        {
                            pointsExplored.Add(newPoint);
                            newPointsToExplore.Add(newPoint);
                        }
                    }
                }

                pointsExploredAtStep.Add(pointsToExplore.Count());
                Console.WriteLine(pointsExploredAtStep.Count() + ": " + pointsExplored.Count());
                pointsToExplore = newPointsToExplore;
            }

            // Print for function analysis
            /*
            List<double> ratios = new List<double>();
            for (var i = 0; i < STEPS - 1; i++)
            {
                var difference = (pointsExploredAtStep[i + 1] - pointsExploredAtStep[i]);
                var area = (double)((i+ 1) * (i + 1));
                var ratio = ((double)pointsExploredAtStep[i] / area);
                Console.WriteLine(i + ":" + (ratio));
                ratios.Add(ratio);
            }

            var averageOfRatios = ratios.TakeLast(100).Average();
            var predict = 5000d;
            Console.WriteLine(averageOfRatios * (predict + 1) * (predict + 1));
for (var i = 0; i < 400; i++)
            {
                Console.Write(i + " ");
            }
            Console.WriteLine();

            for (var i = 0; i < 400; i++)
            {
                Console.Write(pointsExploredAtStep[i] + " ");
            }

            Console.WriteLine();
            for (var i = 0; i < 400; i++)
            {
                var area = (double)((i + 1) * (i + 1));
                var ratio = ((double)pointsExploredAtStep[i] / area);
                Console.Write(ratio + " ");
            }*/

            Console.WriteLine(pointsExploredAtStep[65]); // x = 1 
            Console.WriteLine(pointsExploredAtStep[196]); // x = 2
            Console.WriteLine(pointsExploredAtStep[327]); // x = 3
            Console.WriteLine(pointsExploredAtStep[458]); // x = 4

            // 26501365 = 131 * 202300 + 65;
            // What happens when x = 202301?

            // Wolfram alpha says this is 14613x^2 - 14479x + 3592 for 65
            // Wolfram alpha says this is 14613x^2 - 14223x + 3466 for 66
            var xx = 202301;
            var solution = 14613l * xx * xx - 14479l * xx + 3592l;
            //var solution = 14613l * xx * xx - 14223l * xx + 3466l;
            Console.WriteLine(solution);


            /*for (var x = 0; x < ls[0].Length; x++)
            {
                for (var y = 0; y < ls.Count(); y++)
                {
                    if (pointsExplored.Contains((x, y)))
                    {
                        Console.Write('O');
                    }
                    else
                    {
                        Console.Write(maze[x, y]);
                    }
                }

                Console.WriteLine();
            }*/
        }
    }
}
